services:
  data-init:
    image: curlimages/curl:latest
    depends_on:
      - elasticsearch
      - miserend
    volumes:
      - ./elasticsearch/initdb.d:/elasticsearch/initdb.d
      - data_init_state:/state
    entrypoint: >
      sh -c "
        if [ -f /state/initialized ]; then
          echo "Data initialization already done, skipping.";
          exit 0;
        fi
        until curl -s http://elasticsearch:9200 >/dev/null; do
          echo 'Waiting for Elasticsearch...';
          sleep 2;
        done;
        curl -XPUT 'http://elasticsearch:9200/_cluster/settings' -H 'Content-Type: application/json' -d '{\"transient\": {\"cluster.routing.allocation.disk.watermark.low\": \"2gb\", \"cluster.routing.allocation.disk.watermark.high\": \"1gb\", \"cluster.routing.allocation.disk.watermark.flood_stage\": \"500mb\", \"cluster.info.update.interval\": \"1m\"}}';
        curl -XPUT 'http://elasticsearch:9200/_all/_settings' -H 'Content-Type: application/json' -d '{\"index\": {\"number_of_replicas\": 0}}';
        echo 'Elasticsearch settings applied.';
        # check if churches index exists
        curl -XGET 'http://elasticsearch:9200/churches' -o /dev/null -s -w '%{http_code}' | grep -q 200
        if [ $? -ne 0 ]; then
          echo 'Restoring churches index from snapshot...';
          curl -XPOST 'http://elasticsearch:9200/churches/_bulk' --data-binary @/elasticsearch/initdb.d/churches.json -H 'Content-Type: application/json'
        fi
        # wait for miserend to be up
        until curl -s http://miserend:8000 >/dev/null; do
          echo 'Waiting for miserend...';
          sleep 2;
        done;
        # run the cron jobs
        curl -s 'http://miserend:8000/index.php?q=cron&cron_id=38'
        curl -s 'http://miserend:8000/index.php?q=cron&cron_id=39'
        echo 'Cron jobs triggered.';
        touch /state/initialized
      "
volumes:
  data_init_state: